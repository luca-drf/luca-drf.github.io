<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Luca Da Rin Fioretto | Taming Floating-Point Arithmetic in Python (Part 2)</title>
<meta property="og:title" content="Luca Da Rin Fioretto | Taming Floating-Point Arithmetic in Python (Part 2)"><meta property="og:image" content="https://i.ibb.co/vYkzGmX/joshua-hoehne-AZr-BFo-XP-3-I-unsplash.jpg"><meta property="og:description" content="Blog post on how Python's Decimal and Fractions modules can help debugging and/or overcoming limitations of IEEE-754 floating-point specification."><meta name=description content="Blog post on how Python's Decimal and Fractions modules can help debugging and/or overcoming limitations of IEEE-754 floating-point specification."><meta name=author content="Luca Da Rin Fioretto"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#176d86><meta name=msapplication-TileColor content="#2b5797"><meta name=theme-color content="#ffffff"><meta name=google-site-verification content="xetOSgBfIdaeBqM4aMPpxQJzsVP7a--l6tfp-hMo8T0"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css integrity=sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2 crossorigin=anonymous><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Hebrew&family=Open+Sans:wght@600&family=PT+Sans&family=Saira+Extra+Condensed:wght@500;600;700&display=swap" rel=stylesheet><link rel=preload href=https://use.fontawesome.com/releases/v6.1.1/css/all.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://use.fontawesome.com/releases/v6.1.1/css/all.css></noscript><link rel=stylesheet type=text/css href=https://cdn.jsdelivr.net/gh/devicons/devicon@latest/devicon.min.css><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin=anonymous as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin=anonymous></noscript><link rel=stylesheet href=https://lucadrf.dev/css/resume.min.414409fde43abb59023b361547b918cd28183040139b0236a8913c2957d8a59d.css integrity="sha256-QUQJ/eQ6u1kCOzYVR7kYzSgYMEATmwI2qJE8KVfYpZ0=" media=screen><link rel=stylesheet href=https://lucadrf.dev/css/tweaks.min.5b6d2b73db129a79aadd4e4c805e9b3e69175153c5071b9624cb6ee64a4e7d73.css integrity="sha256-W20rc9sSmnmq3U5MgF6bPmkXUVPFBxuWJMtu5kpOfXM=" media=screen><link rel=stylesheet href=https://lucadrf.dev/css/resume-override.css></head><body id=page-top><nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id=sideNav><a class="navbar-brand js-scroll-trigger" href=#page-top><span class="d-block d-lg-none">Luca Da Rin Fioretto</span>
<span class="d-none d-lg-block"><img class="img-fluid img-profile rounded-circle mx-auto mb-2" src=/img/daro_profile.png alt>
</span></a><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class=navbar-nav><li class=nav-item><a class="nav-link js-scroll-trigger" href=/#about data-target=#about>About</a></li><li class=nav-item><a class="nav-link js-scroll-trigger" href=/#skills data-target=#skills>Skills</a></li><li class=nav-item><a class="nav-link js-scroll-trigger" href=/#experience data-target=#experience>Experience</a></li><li class=nav-item><a class="nav-link js-scroll-trigger" href=/#education data-target=#education>Education</a></li><li class=nav-item><a class="nav-link js-scroll-trigger" href=/#blog data-target=#blog>Blog</a></li></ul></div></nav><div class="container-fluid p-0"><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=https://lucadrf.dev/>Home</a></li><li class=breadcrumb-item><a href=https://lucadrf.dev/blog/>Blogs</a></li><li class="breadcrumb-item active"><a href=https://lucadrf.dev/blog/taming-floating-points-2/>Taming Floating-Point Arithmetic in Python (Part 2)</a></li></ol></nav><div class="resp-container fit-breadcrumbs"><div class=fill><img src=https://i.ibb.co/vYkzGmX/joshua-hoehne-AZr-BFo-XP-3-I-unsplash.jpg alt="A young student is solving arithmetical exercises on a piece of paper"></div></div><section class="resume-section p-3 p-lg-5 d-flex flex-column"><div class=my-auto><div class="mb-3 d-flex flex-row justify-content-between"><h2 class="portfolio mb-0"><span class=text-primary>Taming Floating-Point Arithmetic in Python (Part 2)</span></h2><span>June 23, 2024</span></div><div class=mb-5><h4>Second and last part of the series tackling IEEE-754 floating-point arithmetic with Python. In this post we&rsquo;re looking at how Python&rsquo;s standard library Decimal and Fractions modules can help dealing with floating-point gotchas seen in the previous part.</h4></div><div><h2 id=introduction class=anchored-heading>Introduction <a class="header-link js-scroll-trigger" href=#introduction><i class="fa fa-link anchor-icons"></i></a></h2><p>In the previous <a href=https://lucadrf.dev/blog/taming-floating-points/ title="Taming Floating-Point Arithmetic in Python (Part 1)">part</a>
we explored some practical gotchas that are easily encountered when dealing with
floating-point arithmetic. Luckily,
<a href=https://en.wikipedia.org/wiki/IEEE_754>IEEE-754</a> is not the only standard for
representing decimal numbers on binary based systems; in the late 80s two
standards defining floating-point arithmetic with radices other than 2
(including radix 10) where published
<a href=https://en.wikipedia.org/wiki/IEEE_854-1987>IEEE-754-1985 and IEEE-854-1987</a>
and later merged and revised in <a href=https://en.wikipedia.org/wiki/IEEE_754-2008_revision>IEEE-754-2008</a>.</p><p>IBM Mainframe <a href=https://en.wikipedia.org/wiki/IBM_System_z9>System z9</a> was the
first CPU to implement IEEE-754-2008 in its microcode however most CPUs haven&rsquo;t
adopted this standard. On the other hand, this revision is available through
software as it has been implemented for most programming languages.</p><p>In Python, base 10 floating-point arithmetic is implemented in the standard
library by the <a href=https://docs.python.org/3/library/decimal.html>decimal</a> module,
and is based on IBM&rsquo;s <a href=https://speleotrove.com/decimal/decarith.html>General Decimal Arithmetic Specification</a>.</p><h2 id=pythons-decimal class=anchored-heading>Python&rsquo;s Decimal <a class="header-link js-scroll-trigger" href=#pythons-decimal><i class="fa fa-link anchor-icons"></i></a></h2><p>The <a href=https://docs.python.org/3/library/decimal.html>decimal</a> module provides
support for fast correctly rounded decimal floating-point arithmetic via the
<code>Decimal</code> class which presents several advantages over built-in <code>float</code>:</p><ul><li>Represents decimal numbers exactly, and the exactness carries over into arithmetic</li><li>Incorporates a notion of significant places as arithmetic operations are defined in base 10</li><li>Unlimited precision</li><li>Exposes all required parts of the standard to the user (precision, rounding strategy, signal handling can all be modified)</li><li>Decimal objects are immutable (and <em>hashable</em>)</li><li>Decimal integrates well with other Python’s built-ins (e.g. <code>round()</code>)</li></ul><p>The Decimal specification represents fixed and floating-point numbers as
triplets consisting of <em>sign</em> (a single bit), <em>digits</em> (an array of unsigned
integers) and <em>exponent</em> (a signed integer). For example the number <code>123.45</code> is
represented as:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>(sign=0, digits=(1, 2, 3, 4, 5), exponent=-2)
</span></span></code></pre></div><p>Python&rsquo;s decimal objects can (and should) be instantiated from strings as using
floats would immediately introduce rounding error and noise. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000;font-weight:700>from</span> <span style=color:#555>decimal</span> <span style=color:#000;font-weight:700>import</span> Decimal
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Decimal(<span style=color:#d14>&#34;0.3&#34;</span>)
</span></span><span style=display:flex><span>Decimal(<span style=color:#d14>&#39;0.3&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Decimal(<span style=color:#099>0.3</span>)
</span></span><span style=display:flex><span>Decimal(<span style=color:#d14>&#39;0.299999999999999988897769753748434595763683319091796875&#39;</span>)
</span></span></code></pre></div><p>Note that when instantiating <code>Decimal</code> with <code>float</code> all the digits of the
floating-point representation are stored losing precision and obscuring the
significance. That defeat the purpose when performing operations:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Decimal(<span style=color:#d14>&#34;0.3&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;0.3&#34;</span>)
</span></span><span style=display:flex><span>Decimal(<span style=color:#d14>&#39;0.6&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Decimal(<span style=color:#099>0.3</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#099>0.3</span>)
</span></span><span style=display:flex><span>Decimal(<span style=color:#d14>&#39;0.5999999999999999777955395075&#39;</span>)
</span></span></code></pre></div><h2 id=taming-floating-point-arithmetic-with-decimal class=anchored-heading>Taming floating-point arithmetic with decimal <a class="header-link js-scroll-trigger" href=#taming-floating-point-arithmetic-with-decimal><i class="fa fa-link anchor-icons"></i></a></h2><p>In this section we&rsquo;ll see how we can use decimal effectively for solving the
problems seen in part 1.</p><h3 id=solving-imprecise-addition-and-subtraction class=anchored-heading>Solving imprecise addition and subtraction <a class="header-link js-scroll-trigger" href=#solving-imprecise-addition-and-subtraction><i class="fa fa-link anchor-icons"></i></a></h3><p>Let&rsquo;s consider non-associative addition as seen in this
<a href=https://lucadrf.dev/blog/taming-floating-points/#addition-series-are-not-associative title="Addition series are not associative">example</a>; that&rsquo;s not a problem when using decimal&rsquo;s
arithmetic as numbers gets aligned to the highest absolute exponent then
the sum is carried over in columns (like you would do on a piece of paper).
In fact:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Decimal(<span style=color:#d14>&#34;.9999&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;.00001&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;.00001&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;.00001&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;.00001&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;.00001&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;.00001&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;.00001&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;.00001&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;.00001&#34;</span>) <span style=color:#000;font-weight:700>+</span> Decimal(<span style=color:#d14>&#34;.00001&#34;</span>)
</span></span><span style=display:flex><span>Decimal(<span style=color:#d14>&#39;1.00000&#39;</span>)
</span></span></code></pre></div><p>The result is precise and the resulting <code>Decimal</code> object, stores all the
significant figures (the result is <code>1.00000</code> not <code>1</code>). Hurrah!</p><p>To have look at the decimal tuple stored under the hood, you can use
<code>Decimal.as_tuple()</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Decimal(<span style=color:#d14>&#34;1.00000&#34;</span>)<span style=color:#000;font-weight:700>.</span>as_tuple()
</span></span><span style=display:flex><span>DecimalTuple(sign<span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span>, digits<span style=color:#000;font-weight:700>=</span>(<span style=color:#099>1</span>, <span style=color:#099>0</span>), exponent<span style=color:#000;font-weight:700>=-</span><span style=color:#099>5</span>)
</span></span></code></pre></div><p>The same logic is applied to subtraction, therefore solving the floating-point
imprecision when subtracting nearly equal numbers seen in
<a href=https://lucadrf.dev/blog/taming-floating-points/#subtracting-nearly-equal-numbers-is-not-precise title="Subtracting nearly equal numbers is not precise">example</a>.</p><h3 id=helping-with-rounding class=anchored-heading>Helping with rounding <a class="header-link js-scroll-trigger" href=#helping-with-rounding><i class="fa fa-link anchor-icons"></i></a></h3><p>As mentioned before, <code>Decimal</code> object works well with other built-ins. Here&rsquo;s
how rounding invariant works as expected instead of breaking when rounding
floats in this <a href=https://lucadrf.dev/blog/taming-floating-points/#rounding title=Rounding>example</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#0086b3>round</span>(<span style=color:#0086b3>round</span>(Decimal(<span style=color:#d14>&#34;9.9995&#34;</span>), <span style=color:#099>3</span>) <span style=color:#000;font-weight:700>-</span> <span style=color:#0086b3>round</span>(Decimal(<span style=color:#d14>&#34;9.9975&#34;</span>), <span style=color:#099>3</span>), <span style=color:#099>3</span>)
</span></span><span style=display:flex><span>Decimal(<span style=color:#d14>&#39;0.002&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#0086b3>round</span>(<span style=color:#0086b3>round</span>(Decimal(<span style=color:#d14>&#34;17.9995&#34;</span>), <span style=color:#099>3</span>) <span style=color:#000;font-weight:700>-</span> <span style=color:#0086b3>round</span>(Decimal(<span style=color:#d14>&#34;17.9975&#34;</span>), <span style=color:#099>3</span>), <span style=color:#099>3</span>)
</span></span><span style=display:flex><span>Decimal(<span style=color:#d14>&#39;0.002&#39;</span>)
</span></span></code></pre></div><p>Also, as mentioned before, the decimal module exposes all parts of the standard,
for example, the rounding strategy can be modified from the standard
&ldquo;Round Half Even&rdquo;. In order to do that you can use <code>Decimal.quantize()</code> method:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000;font-weight:700>from</span> <span style=color:#555>decimal</span> <span style=color:#000;font-weight:700>import</span> ROUND_UP
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Decimal(<span style=color:#d14>&#34;4.5&#34;</span>)<span style=color:#000;font-weight:700>.</span>quantize(Decimal(<span style=color:#d14>&#34;0&#34;</span>), rounding<span style=color:#000;font-weight:700>=</span>ROUND_UP)
</span></span><span style=display:flex><span>Decimal(<span style=color:#d14>&#39;5&#39;</span>)
</span></span></code></pre></div><p>Decimal&rsquo;s rounding strategies include: <code>ROUND_CEILING</code>, <code>ROUND_DOWN</code>,
<code>ROUND_FLOOR</code>, <code>ROUND_HALF_DOWN</code>, <code>ROUND_HALF_EVEN</code>, <code>ROUND_HALF_UP</code>,
<code>ROUND_UP</code>, and <code>ROUND_05UP</code>.</p><p>Note that <code>quantize()</code> first argument is a <code>Decimal</code> object, that&rsquo;s to define
the exponent (which is extracted from the <code>Decimal</code> instance), personally I wish
there was a way to pass the exponent as a number, to be able to write more
concise code (or for <code>Decimal</code> to implement a <code>round()</code> method similar to the
built-in).</p><h3 id=helping-with-significance-eater class=anchored-heading>Helping with significance eater <a class="header-link js-scroll-trigger" href=#helping-with-significance-eater><i class="fa fa-link anchor-icons"></i></a></h3><p>Onto more complex examples, we can rewrite the &ldquo;Significance Eater&rdquo; code seen in
<a href=https://lucadrf.dev/blog/taming-floating-points/#the-significance-eater title="The significance eater">example</a>
using <code>Decimal</code> to mitigate the behaviour:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>significance_eater</span>():
</span></span><span style=display:flex><span>    x <span style=color:#000;font-weight:700>=</span> Decimal(<span style=color:#d14>&#34;10.0&#34;</span>) <span style=color:#000;font-weight:700>/</span> Decimal(<span style=color:#d14>&#34;9.0&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>for</span> _ <span style=color:#000;font-weight:700>in</span> <span style=color:#0086b3>range</span>(<span style=color:#099>25</span>):
</span></span><span style=display:flex><span>        <span style=color:#0086b3>print</span>(x)
</span></span><span style=display:flex><span>        x <span style=color:#000;font-weight:700>=</span> (x <span style=color:#000;font-weight:700>-</span> Decimal(<span style=color:#d14>&#34;1.0&#34;</span>)) <span style=color:#000;font-weight:700>*</span> Decimal(<span style=color:#d14>&#34;10.0&#34;</span>)
</span></span></code></pre></div><p>Running the above code&mldr;</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> significance_eater()
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111111111111111</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111111111111110</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111111111111100</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111111111111000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111111111110000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111111111100000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111111111000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111111110000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111111100000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111111000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111110000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111100000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111111000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111110000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111100000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111111000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111110000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111100000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111111000000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111110000000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111100000000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111111000000000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111110000000000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111100000000000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#099>1.111000000000000000000000000</span>
</span></span></code></pre></div><p>Note that the loss of significance is still happening due to the finite number
of digit stored by <code>Decimal</code> which are defined by decimal module precision
setting; however the catastrophic cancellation is a bit more manageable.</p><p>As mentioned before, decimal precision can be modified by the user, and it&rsquo;s
part of decimal <code>Context</code> object which is a singleton instance storing decimal
module&rsquo;s settings and events occurred since module import.</p><p>The <code>Context</code> instance can be accessed via <code>decimal.getcontext()</code> function:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000;font-weight:700>from</span> <span style=color:#555>decimal</span> <span style=color:#000;font-weight:700>import</span> getcontext
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> getcontext()
</span></span><span style=display:flex><span>Context(prec<span style=color:#000;font-weight:700>=</span><span style=color:#099>28</span>, rounding<span style=color:#000;font-weight:700>=</span>ROUND_HALF_EVEN, Emin<span style=color:#000;font-weight:700>=-</span><span style=color:#099>999999</span>, Emax<span style=color:#000;font-weight:700>=</span><span style=color:#099>999999</span>, capitals<span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span>, clamp<span style=color:#000;font-weight:700>=</span><span style=color:#099>0</span>, flags<span style=color:#000;font-weight:700>=</span>[], traps<span style=color:#000;font-weight:700>=</span>[InvalidOperation, DivisionByZero, Overflow])
</span></span></code></pre></div><p>To modify the precision, simply:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> getcontext()<span style=color:#000;font-weight:700>.</span>prec <span style=color:#000;font-weight:700>=</span> <span style=color:#099>64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Decimal(<span style=color:#d14>&#34;10.0&#34;</span>) <span style=color:#000;font-weight:700>/</span> Decimal(<span style=color:#d14>&#34;9.0&#34;</span>)
</span></span><span style=display:flex><span>Decimal(<span style=color:#d14>&#39;1.111111111111111111111111111111111111111111111111111111111111111&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> getcontext()<span style=color:#000;font-weight:700>.</span>prec <span style=color:#000;font-weight:700>=</span> <span style=color:#099>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Decimal(<span style=color:#d14>&#34;10.0&#34;</span>) <span style=color:#000;font-weight:700>/</span> Decimal(<span style=color:#d14>&#34;9.0&#34;</span>)
</span></span><span style=display:flex><span>Decimal(<span style=color:#d14>&#39;1.11111111111111111111111111111&#39;</span>)
</span></span></code></pre></div><p>That&rsquo;s nice!</p><p>The <code>Context</code> object can be used to modify other <code>decimal</code> module settings;
the rounding strategy, for instance, can be set to any of the rounding
<a href=https://docs.python.org/3/library/decimal.html#rounding-modes>modes</a>
available in order to modify the behaviour of all rounding operations performed
by the module.</p><p>Another powerful tool are <a href=https://docs.python.org/3/library/decimal.html#signals>Signals</a>
which can be set as <code>traps</code> in order to raise an exception as soon as an
operation triggers one, or can be monitored in the <code>flags</code> list.
See <a href=https://docs.python.org/3/library/decimal.html#decimal.Context>Context</a>
full docs for more info.</p><h3 id=helping-with-simple-variance-calculator-example class=anchored-heading>Helping with Simple Variance Calculator example <a class="header-link js-scroll-trigger" href=#helping-with-simple-variance-calculator-example><i class="fa fa-link anchor-icons"></i></a></h3><p>Let&rsquo;s see how decimal module can fix our &ldquo;Simple Variance Calculator&rdquo;
<a href=https://lucadrf.dev/blog/taming-floating-points/#simple-variance-calculator title="Simple Variance Calculator">example</a>.</p><p>The definition of the function was:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> <span style=color:#555>numpy</span> <span style=color:#000;font-weight:700>as</span> <span style=color:#555>np</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>def</span> <span style=color:#900;font-weight:700>simple_variance</span>(nums):
</span></span><span style=display:flex><span>    sum_of_squares <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>    sum_of_nums <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>    N <span style=color:#000;font-weight:700>=</span> <span style=color:#0086b3>len</span>(nums)
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>for</span> num <span style=color:#000;font-weight:700>in</span> nums:
</span></span><span style=display:flex><span>        sum_of_squares <span style=color:#000;font-weight:700>+=</span> num<span style=color:#000;font-weight:700>**</span><span style=color:#099>2</span>
</span></span><span style=display:flex><span>        sum_of_nums <span style=color:#000;font-weight:700>+=</span> num
</span></span><span style=display:flex><span>    variance <span style=color:#000;font-weight:700>=</span> (sum_of_squares <span style=color:#000;font-weight:700>-</span> sum_of_nums<span style=color:#000;font-weight:700>**</span><span style=color:#099>2</span> <span style=color:#000;font-weight:700>/</span> N) <span style=color:#000;font-weight:700>/</span> N
</span></span><span style=display:flex><span>    <span style=color:#0086b3>print</span>(<span style=color:#d14>f</span><span style=color:#d14>&#34;Real variance: </span><span style=color:#d14>{</span>np<span style=color:#000;font-weight:700>.</span>var(nums)<span style=color:#d14>}</span><span style=color:#d14>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#0086b3>print</span>(<span style=color:#d14>f</span><span style=color:#d14>&#34;Simp variance: </span><span style=color:#d14>{</span>variance<span style=color:#d14>}</span><span style=color:#d14>&#34;</span>)
</span></span></code></pre></div><p>In this case, we simply pass <code>Decimal</code> objects instead of <code>float</code>&rsquo;s:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> simple_variance([Decimal(<span style=color:#0086b3>str</span>(x)) <span style=color:#000;font-weight:700>for</span> x <span style=color:#000;font-weight:700>in</span> np<span style=color:#000;font-weight:700>.</span>random<span style=color:#000;font-weight:700>.</span>uniform(<span style=color:#099>1_000_000</span>, <span style=color:#099>1_000_000.06</span>, <span style=color:#099>100_000</span>)])
</span></span><span style=display:flex><span>Real variance: <span style=color:#099>0.00030060149786485578863919</span>
</span></span><span style=display:flex><span>Simp variance: <span style=color:#099>0.00030060148</span>
</span></span></code></pre></div><p>The result is better but not quite there yet. Luckily we can increase the
precision to be able to get a more precise result:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> getcontext()<span style=color:#000;font-weight:700>.</span>prec <span style=color:#000;font-weight:700>=</span> <span style=color:#099>48</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> simple_variance([Decimal(<span style=color:#0086b3>str</span>(x)) <span style=color:#000;font-weight:700>for</span> x <span style=color:#000;font-weight:700>in</span> np<span style=color:#000;font-weight:700>.</span>random<span style=color:#000;font-weight:700>.</span>uniform(<span style=color:#099>1_000_000</span>, <span style=color:#099>1_000_000.06</span>, <span style=color:#099>100_000</span>)])
</span></span><span style=display:flex><span>Real variance: <span style=color:#099>0.000301466911246091199506375296</span>
</span></span><span style=display:flex><span>Simp variance: <span style=color:#099>0.000301466911246091199506375296</span>
</span></span></code></pre></div><p>Perfect!</p><h3 id=fraction-module class=anchored-heading>Fraction module <a class="header-link js-scroll-trigger" href=#fraction-module><i class="fa fa-link anchor-icons"></i></a></h3><p>Another very interesting tool present in Python&rsquo;s standard library is the
<a href=https://docs.python.org/3/library/fractions.html>fractions</a> module which can
greatly help in dealing with operations having inherently rational numbers.
Similarly to <code>decimal</code>, <code>fractions</code> implements a <code>Fraction</code> class which can be
used to represent rational numbers and implements rational arithmetic.</p><p>For example, to represent the fraction 11/10 using floats we&rsquo;d use 1.1 but
that would result in an approximation:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000;font-weight:700>from</span> <span style=color:#555>fractions</span> <span style=color:#000;font-weight:700>import</span> Fraction
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Fraction(<span style=color:#099>1.1</span>)
</span></span><span style=display:flex><span>Fraction(<span style=color:#099>2476979795053773</span>, <span style=color:#099>2251799813685248</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Fraction(<span style=color:#099>1.1</span>) <span style=color:#000;font-weight:700>==</span> Fraction(<span style=color:#d14>&#34;11/10&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>False</span>
</span></span></code></pre></div><p>With <code>Fraction</code> we can exactly represent 11/10, and we can adjust floats to
their nearest rational number with its <code>limit_denominator()</code> method:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Fraction(<span style=color:#099>1.1</span>)<span style=color:#000;font-weight:700>.</span>limit_denominator() <span style=color:#000;font-weight:700>==</span> Fraction(<span style=color:#d14>&#34;11/10&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#000;font-weight:700>from</span> <span style=color:#555>math</span> <span style=color:#000;font-weight:700>import</span> pi, cos
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Fraction(cos(pi<span style=color:#000;font-weight:700>/</span><span style=color:#099>3</span>))
</span></span><span style=display:flex><span>Fraction(<span style=color:#099>4503599627370497</span>, <span style=color:#099>9007199254740992</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Fraction(cos(pi<span style=color:#000;font-weight:700>/</span><span style=color:#099>3</span>))<span style=color:#000;font-weight:700>.</span>limit_denominator()
</span></span><span style=display:flex><span>Fraction(<span style=color:#099>1</span>, <span style=color:#099>2</span>)
</span></span></code></pre></div><p>Nice! More examples:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#099>0.1</span> <span style=color:#000;font-weight:700>+</span> <span style=color:#099>0.1</span> <span style=color:#000;font-weight:700>+</span> <span style=color:#099>0.1</span> <span style=color:#000;font-weight:700>==</span> <span style=color:#099>0.3</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Fraction(<span style=color:#d14>&#34;1/10&#34;</span>) <span style=color:#000;font-weight:700>+</span> Fraction(<span style=color:#d14>&#34;1/10&#34;</span>) <span style=color:#000;font-weight:700>+</span> Fraction(<span style=color:#d14>&#34;1/10&#34;</span>) <span style=color:#000;font-weight:700>==</span> Fraction(<span style=color:#d14>&#34;3/10&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#0086b3>float</span>(Fraction(<span style=color:#d14>&#34;1/10&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#099>0.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> <span style=color:#0086b3>float</span>(Fraction(<span style=color:#d14>&#34;3/10&#34;</span>))
</span></span><span style=display:flex><span><span style=color:#099>0.3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Fraction(Decimal(<span style=color:#d14>&#34;1.1&#34;</span>))
</span></span><span style=display:flex><span>Fraction(<span style=color:#099>11</span>, <span style=color:#099>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;&gt;&gt;</span> Decimal(<span style=color:#d14>&#34;1.1&#34;</span>)<span style=color:#000;font-weight:700>.</span>as_integer_ratio()
</span></span><span style=display:flex><span>(<span style=color:#099>11</span>, <span style=color:#099>10</span>)
</span></span></code></pre></div><p>Note how <code>Fraction</code> can be used to convert a rational number back to its nearest
float, and how a <code>Decimal</code> object represents 1.1 correctly to its ratio 11/10,
which can be obtained with <code>Decimal</code> method <code>as_integer_ratio()</code>.</p><h2 id=conclusions class=anchored-heading>Conclusions <a class="header-link js-scroll-trigger" href=#conclusions><i class="fa fa-link anchor-icons"></i></a></h2><p>The decimal module provides support for fast correctly rounded decimal
floating-point arithmetic, and it&rsquo;s great for debugging code with complex logic
involving <code>float</code>s.</p><p>In my opinion, overall helps a lot in writing more simple/readable code as it
integrates well with other Python’s built-in as well as other libraries like
pandas, although with some performance hit. Note: Arithmetic operations between
<code>Decimal</code> and <code>float</code> will raise <code>TypeError</code>.</p><p>Based on simple (by no mean exhaustive) tests, Decimal arithmetic operations
seems to be ~70% slower than float, worth noting that CPython uses libmpdec
where possible and other implementations of Decimal are available that might be
faster (e.g. Apache Arrow <code>pyarrow.decimal128</code>).</p><p>Lastly, <code>fractions</code> module is an elegant solution for handling rational numbers,
and its <code>limit_denominator()</code> method is very useful.</p><p>This concludes our two part journey in the vast and perilous world of
floating-point arithmetic. Hopefully these posts will help you avoid some of
the pitfalls and/or help in troubleshooting them.</p></div></div></section><span style=color:#999;font-size:60%>Copyright &copy; 2024 Luca Da Rin Fioretto.</span>
<span style=color:#999;font-size:60%>Based on <a href=https://github.com/eddiewebb/hugo-resume>hugo-resume</a> theme and generated with <a href=https://gohugo.io/>HUGO</a></span></div><script src=https://code.jquery.com/jquery-3.6.4.slim.min.js integrity="sha256-a2yjHM4jnF9f54xUQakjZGaqYs/V1CYvWpoqZzC2/Bw=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js integrity=sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx crossorigin=anonymous></script><script src=https://unpkg.com/smoothscroll-polyfill@0.4.4/dist/smoothscroll.min.js integrity=sha384-EYn4rWu1DHvYD0sSSSbMEtXQmMl58CFJd897806+RT1jJVYbhuZlZMN6yG9nCyFa crossorigin=anonymous></script><script src=https://unpkg.com/smoothscroll-anchor-polyfill@1.3.2/dist/index.min.js integrity=sha384-EY9NBEHCFbZANmPcTm7CgG8OhsFILy0VBLG85pF6OIpP42NVbZVNsFOc23PYTCkB crossorigin=anonymous></script><script async src=https://lucadrf.dev/js/resume.min.js></script></body></html>