<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Luca Da Rin Fioretto | Build uAMQP Python wheel for arm64v8</title><meta property="og:title" content="Luca Da Rin Fioretto | Build uAMQP Python wheel for arm64v8"><meta property="og:image" content="https://lucadrf.dev/img/daro_profile.png"><meta name=description content><meta property="og:description" content><meta name=author content="Luca Da Rin Fioretto"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#176d86><meta name=msapplication-TileColor content="#2b5797"><meta name=theme-color content="#ffffff"><meta name=google-site-verification content="xetOSgBfIdaeBqM4aMPpxQJzsVP7a--l6tfp-hMo8T0"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css integrity=sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2 crossorigin=anonymous><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Hebrew&family=Open+Sans:wght@600&family=PT+Sans&family=Saira+Extra+Condensed:wght@500;600;700&display=swap" rel=stylesheet><link rel=preload href=https://use.fontawesome.com/releases/v6.1.1/css/all.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://use.fontawesome.com/releases/v6.1.1/css/all.css></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css><link rel=preload href=https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin=anonymous as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin=anonymous></noscript><link rel=stylesheet href=https://lucadrf.dev/css/resume.min.620ca4b022d0576157a0dac61effe466da1c9b440464b3c47ba2ee73a7355da2.css integrity="sha256-YgyksCLQV2FXoNrGHv/kZtocm0QEZLPEe6Luc6c1XaI=" media=screen><link rel=stylesheet href=https://lucadrf.dev/css/tweaks.min.ba72f72a41b1964695f57c2ee5baa55c66fa14f1aa3ead965730368e56b6cf3d.css integrity="sha256-unL3KkGxlkaV9Xwu5bqlXGb6FPGqPq2WVzA2jla2zz0=" media=screen><link rel=stylesheet href=https://lucadrf.dev/css/resume-override.css></head><body id=page-top><nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id=sideNav><a class="navbar-brand js-scroll-trigger" href=#page-top><span class="d-block d-lg-none">Luca Da Rin Fioretto</span>
<span class="d-none d-lg-block"><img class="img-fluid img-profile rounded-circle mx-auto mb-2" src=/img/daro_profile.png alt></span></a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class=navbar-nav><li class=nav-item><a class="nav-link js-scroll-trigger" href=/#about data-target=#about>About</a></li><li class=nav-item><a class="nav-link js-scroll-trigger" href=/#skills data-target=#skills>Skills</a></li><li class=nav-item><a class="nav-link js-scroll-trigger" href=/#experience data-target=#experience>Experience</a></li><li class=nav-item><a class="nav-link js-scroll-trigger" href=/#education data-target=#education>Education</a></li><li class=nav-item><a class="nav-link js-scroll-trigger" href=/#blog data-target=#blog>Blog</a></li></ul></div></nav><div class="container-fluid p-0"><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=https://lucadrf.dev/>Home</a></li><li class=breadcrumb-item><a href=https://lucadrf.dev/blog/>Blogs</a></li><li class="breadcrumb-item active"><a href=https://lucadrf.dev/blog/uamqp-manylinux-arm64/>Build uAMQP Python wheel for arm64v8</a></li></ol></nav><section class="resume-section p-3 p-lg-5 d-flex flex-column"><div class="mb-3 d-flex flex-row justify-content-between"><div class=my-auto><h2 class="portfolio mb-0"><span class=text-primary>Build uAMQP Python wheel for arm64v8</span></h2><div class=mb-5><h4>Build Microsoft uAMQP Python package painlessly with Manylinux docker image</h4></div><div><h2 id=tldr class=anchored-heading>TL;DR <a class="anchor js-scroll-trigger" href=#tldr><i class="fa fa-link anchor-icons"></i></a></h2><p>See this <a href=https://gist.github.com/luca-drf/30921511c18559fd6f5c4fa7b94e4615>gist</a></p><h2 id=problem class=anchored-heading>Problem <a class="anchor js-scroll-trigger" href=#problem><i class="fa fa-link anchor-icons"></i></a></h2><p>Most of Microsoft Azure&rsquo;s Python packages have
<a href=https://pypi.org/project/uamqp/>uAMQP</a>
(<a href=https://github.com/Azure/azure-uamqp-python>azure-uamqp-python</a>) as a
dependency, hence if you&rsquo;re developing any automation involving Azure with
Python, you&rsquo;d almost certainly need to install it in your pipeline. Under the
hood, Python <code>uAMQP</code> uses its C counterpart
<a href=https://github.com/Azure/azure-uamqp-c>azure-uamqp-c</a> as an extension,
therefore that&rsquo;s required as an appropriate byte-compiled library for the target
architecture, system and Python version the pipeline is running on.</p><p>In most cases, third-party Python packages that requires C extensions are
shipped in archives where the Python code is packaged alongside the compiled
extensions. Such archives are called <a href=https://pythonwheels.com/>wheels</a> and can
be installed as any other third-party package, using
<a href=https://pip.pypa.io/en/stable/>Pip</a>, given that pre-built wheels targeting
architecture, system and Python version <code>Pip</code> is installing on, are provided and
available on the PyPI repository for the package.</p><p>Microsoft is publishing <code>uAMQP</code> Python wheels targeting Windows, Linux and
MacOS, and for all live major Python 3 versions (3.7+). The only problem is that
the only targeted architecture is x86_64 (see last
<a href=https://pypi.org/project/uamqp/#files>uAMQP release</a> on PyPI).</p><p>To be fair the source code is well engineered and can be fairly easily compiled
for Linux on Arm architectures, in fact <code>uAMQP</code> GitHub repo, features
build scripts for Python 3.5 on armV7 (which could probably work on a Raspberry
PI 2
<a href=https://github.com/Azure/azure-uamqp-python/blob/main/build_armv7l.sh>see here</a>)
but the <a href=https://github.com/Azure/azure-uamqp-python/blob/main/build_many_linux.sh>Manylinux one</a>
is strictly targeting x86_64.</p><p>So as arm64v8 based servers are becoming widely adopted by public Cloud
providers, I find quite peculiar the lack of arm64 pre-built wheels on PyPI.
It&rsquo;s definitely not a technical challenge/burden for <code>uAMQP</code> maintainers (I
think), and I hope they&rsquo;ll start providing them, and so are other devs on
<a href=https://github.com/Azure/azure-uamqp-python/issues/349>azure-uamqp-python&rsquo;s Issues on GitHub</a>.</p><p>Don&rsquo;t get me wrong, I&rsquo;m really glad the direction Microsoft took in the last
decade, heavily investing on Open Source and Python. Kudos to them!</p><h2 id=a-solution class=anchored-heading>A solution <a class="anchor js-scroll-trigger" href=#a-solution><i class="fa fa-link anchor-icons"></i></a></h2><p>So in the meantime, if you need to build <code>uAMQP</code> for your Linux system running
on Arm, below is a build script that should do the trick. It requires docker and
an image provided by the amazing <a href=https://github.com/pypa/manylinux>Manylinux project</a>.</p><script type=application/javascript src="https://gist.github.com/luca-drf/30921511c18559fd6f5c4fa7b94e4615.js?file=build-uamqp-arm-wheel.sh"></script><h3 id=cross-compile-aarch64-on-x86_64 class=anchored-heading>Cross compile aarch64 on x86_64 <a class="anchor js-scroll-trigger" href=#cross-compile-aarch64-on-x86_64><i class="fa fa-link anchor-icons"></i></a></h3><p>Note that you can use the same script to cross compile for aarch64 on a Linux
x86_64 machine, thanks to the very clever
<a href=https://github.com/multiarch/qemu-user-static>qemu-user-static</a> docker image
by simply running the following container before the above script:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
</span></span></code></pre></div><p>I&rsquo;m not going to go into details on how the above works as it&rsquo;s a bit out of the
scope of this post, but I strongly recommend to everyone
<a href=https://github.com/multiarch/qemu-user-static/blob/master/docs/developers_guide.md>reading about it</a>
as what they did is a beautiful hack and, in my opinion, shows why running
containers in <em>privileged</em> mode can be both powerful and extremely dangerous at
the same time.</p></div></div><span>December 10, 2022</span></div></section><span style=color:#999;font-size:60%>Copyright &copy; 2022 Luca Da Rin Fioretto.</span>
<span style=color:#999;font-size:60%>Based on <a href=https://github.com/eddiewebb/hugo-resume>hugo-resume</a> theme and generated with <a href=https://gohugo.io/>HUGO</a></span></div><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js integrity=sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx crossorigin=anonymous></script>
<script async src=https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js integrity="sha512-0QbL0ph8Tc8g5bLhfVzSqxe9GERORsKhIn1IrpxDAgUsbBGz/V7iSav2zzW325XGd1OMLdL4UiqRJj702IeqnQ==" crossorigin=anonymous></script>
<script async src=https://lucadrf.dev/js/resume.min.js></script></body></html>